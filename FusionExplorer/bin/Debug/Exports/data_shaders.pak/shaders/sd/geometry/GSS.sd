<shader filename="shaders/src/geometry/GSS.fx" renderer="GeometryGbufferDefault" showToArtist="1">
  <shadowlayer filename="shaders/sd/shadow/shadow.sd"/>
  <vtlayer filename="shaders/sd/vt/pagerequest/vtpagerequest.sd"/>
  <targetConfigurations editor="1" nvidia="1"/>
  <techniques>
		<technique vs="vs_main" ps="ps_main">
			<rasterizer>
			</rasterizer>
			<blend>
			</blend>
			<depthstencil>
			    <state stencilEnable = "true"/>
			    <state stencilReadMask = "248" />
			    <state stencilWriteMask = "248" />
			    <state frontStencilFunc = "always" />
			    <state frontStencilOpPass = "replace" />
				<!--state hiStencilReadEnable = "false" />
				<state hiStencilWriteEnable = "false" />
				<state hiStencilFunc = "equal" /-->
			    <state stencilRef = "16" />			
			</depthstencil>	
		</technique>
		<technique vs="vs_main" ps="ps_main">
			<defines>
				<define name="USE_LOD_DISSOLVE" value="1"/>
			</defines>		
			<rasterizer>
			</rasterizer>
			<blend>
			</blend>
			<depthstencil>
			    <state stencilEnable = "true"/>
			    <state stencilReadMask = "248" />
			    <state stencilWriteMask = "248" />
			    <state frontStencilFunc = "always" />
			    <state frontStencilOpPass = "replace" />
				<!--state hiStencilReadEnable = "false" />
				<state hiStencilWriteEnable = "false" />
				<state hiStencilFunc = "equal" /-->
			    <state stencilRef = "16" />			
			</depthstencil>	
		</technique>		
	</techniques>
	<vertexformat>
		<vxf name="texcoords" stream="0" format="HALF2"/>
		<!-- position used to be HALF3 but since it was not packed it was still streamed as HALF4 -->
		<vxf name="position" stream="0" format="SHORT4"/>
		<vxf name="normal" stream="0" format="UDEC3N"/>
		<vxf name="tangent" stream="0" format="UDEC3N"/>
	</vertexformat>
	<textures>
		<sources>
			<source name="diffuse"/>
			<source name="roughness"/>
			<source name="AO"/>			
			<source name="normal"/>
			<source name="spec"/>
			<source name="height"/>			
		</sources>
		<inputs>
			<input name="ncombine1" x360="-1">
				<channel source="diffuse" channel="2"/>
				<channel source="diffuse" channel="1"/>
				<channel source="diffuse" channel="0"/>
				<channel source="normal" channel="2"/>
			</input>
			<input name="ncombine1" x360="1">
				<channel source="diffuse[2]*AO[1]"/>
				<channel source="diffuse[1]*AO[1]"/>
				<channel source="diffuse[0]*AO[1]"/>
				<channel source="normal" channel="2"/>
			</input>
			<input name="ncombine2" x360="1">
				<channel source="height" channel="1"/>
				<channel source="roughness" channel="1"/>
				<channel source="spec" channel="1"/>
				<channel source="normal" channel="1"/>
			</input>			
			<input name="ncombine2" x360="-1">
				<channel source="AO" channel="1"/>
				<channel source="roughness" channel="1"/>
				<channel source="spec" channel="1"/>
				<channel source="normal" channel="1"/>
			</input>
			<input name="ncombine3" x360="-1">
				<channel source="AO" channel="1"/>
				<channel source="spec" channel="2"/>
				<channel source="spec" channel="0"/>
				<channel source="height" channel="1"/>
			</input>			
		</inputs>
	</textures>
	<datadescriptors instanceDataCount="8">
		<descriptor name="diffuse" size="3" init="1,1,1"/>
		<descriptor name="emissiveMax" size="1" init="1" max="10" min="0"/>	
		<descriptor name="diffuse2" size="3" init="1,1,1"/>
		<descriptor name="roughnessMul" size="1" init="1" min="0" max="3"/>
		<descriptor name="specMul" size="1" init="1" min="0" max="3"/>
		<descriptor name="aoMul" size="1" init="1" min="0" max="3"/>
		<descriptor name="heightMul" size="1" init="1" min="0" max="3"/>
	</datadescriptors>
	<constantIncludes>
		<constantInclude file="constantsScene.h">
				<struct name="SceneConstants" registerDX10="0" registerStartX360="0"/>
		</constantInclude>
		<constantInclude file="object\constants_object_default.h">
			<struct name="objectConstantsPS" registerDX10="1" registerStartX360="16"/>
			<struct name="objectConstantsVS" registerDX10="1" registerStartX360="16"/>
			<struct name="objectVariablesPS" registerDX10="2" registerStartX360="20"/>
			<struct name="objectVariablesVS" registerDX10="2" registerStartX360="20"/>
		</constantInclude>
	</constantIncludes>	
	<constantBuffers>
		<constantbuffer startPS="0" sizePS="16" startVS="0" sizeVS="16"/>
		<constantbuffer startPS="16" sizePS="3" startVS="16" sizeVS="1"/>
		<constantbuffer startPS="20" sizePS="1" startVS="20" sizeVS="8"/>
	</constantBuffers>
</shader>
